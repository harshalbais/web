<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üåç Multilingual AI Voice Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 min-h-screen flex items-center justify-center font-sans">

  <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-lg">
    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
      <i class="bi bi-mic-fill text-purple-600"></i> Multilingual AI Voice Assistant
    </h2>

    <!-- Language Selector -->
    <label for="langSelect" class="block text-sm font-medium text-gray-700 mb-2">Choose Language</label>
    <select id="langSelect"
            class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 mb-4">
      <option value="en-US">English (US)</option>
      <option value="hi-IN">Hindi</option>
      <option value="mr-IN">Marathi</option>
      <option value="fr-FR">French</option>
      <option value="de-DE">German</option>
    </select>

    <!-- Controls -->
    <div class="flex items-center gap-3 mb-4">
      <button id="btnStart"
              class="flex items-center gap-2 bg-green-500 text-white px-5 py-2 rounded-xl hover:bg-green-600 transition shadow-lg">
        <i class="bi bi-play-fill text-xl"></i> Start
      </button>
      <button id="btnStop"
              class="flex items-center gap-2 bg-red-500 text-white px-5 py-2 rounded-xl hover:bg-red-600 transition shadow-lg">
        <i class="bi bi-stop-fill text-xl"></i> Stop
      </button>
      <span id="status" class="text-sm text-gray-600"></span>
    </div>

    <!-- Chat -->
    <div id="chatBox" class="bg-gray-50 rounded-xl p-4 h-80 overflow-y-auto shadow-inner space-y-3 text-sm"></div>
  </div>

  <script>
    let recognition = null;
    let manuallyStopped = false;
    let isRecognizing = false;

    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const chatBox = document.getElementById("chatBox");
    const statusEl = document.getElementById("status");
    const langSelect = document.getElementById("langSelect");

    // Append chat bubble
    function addBubble(sender, text, side = "left") {
      const bubble = document.createElement("div");
      bubble.className = `max-w-[85%] ${side === "left" ? "self-start" : "self-end"} flex`;
      bubble.innerHTML = `
        <div class="${side === "left" ? "bg-white" : "bg-purple-100"} rounded-2xl px-3 py-2 shadow text-gray-800">
          <span class="font-semibold">${sender}:</span> ${escapeHtml(text)}
        </div>
      `;
      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Escape HTML
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[s]));
    }

    // TTS with language fallback
    function speakText(text, lang) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      const voices = speechSynthesis.getVoices();
      const exact = voices.find(v => v.lang === lang);
      const loose = voices.find(v => v.lang.startsWith(lang.split("-")[0]));
      utterance.voice = exact || loose || null;
      utterance.rate = 0.98;
      speechSynthesis.speak(utterance);
    }

    // Start speech recognition
    function startRecognition() {
      if (isRecognizing) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        addBubble("System", "Your browser does not support SpeechRecognition. Please use Chrome or Edge.", "left");
        return;
      }
      manuallyStopped = false;
      recognition = new SR();
      recognition.lang = langSelect.value;
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isRecognizing = true;
        statusEl.textContent = "Listening‚Ä¶";
      };

      recognition.onresult = (event) => {
        const text = event.results[event.results.length - 1][0].transcript.trim();
        if (!text) return;
        if (speechSynthesis.speaking) speechSynthesis.cancel();
        addBubble("You", text, "right");
        sendToBackend(text, recognition.lang);
      };

      recognition.onerror = (e) => {
        console.warn("Recognition error:", e.error);
      };

      recognition.onend = () => {
  isRecognizing = false;
  if (manuallyStopped) {
    statusEl.textContent = "Stopped.";
    return;
  }

  statusEl.textContent = "Reconnecting‚Ä¶";

  // Restart after a small delay to avoid flicker
  setTimeout(() => {
    if (!manuallyStopped && !isRecognizing) {
      try {
        recognition.start();
      } catch (e) {
        console.warn("Restart error:", e);
      }
    }
  }, 800); // 800ms delay helps avoid flicker
};


    function stopRecognition() {
      manuallyStopped = true;
      if (recognition) {
        try { recognition.stop(); } catch {}
      }
      statusEl.textContent = "Stopped.";
      isRecognizing = false;
    }

    // Send text to Flask /chat
    async function sendToBackend(text, lang) {
      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text, lang })
        });
        const data = await res.json();
        const reply = data.reply || "Sorry, I couldn't process that.";
        addBubble("AI", reply, "left");
        speakText(reply, data.lang || lang);
      } catch (e) {
        addBubble("System", "Network error. Please try again.", "left");
      }
    }

    btnStart.addEventListener("click", startRecognition);
    btnStop.addEventListener("click", stopRecognition);
    window.addEventListener("beforeunload", () => {
      manuallyStopped = true;
      if (recognition) try { recognition.stop(); } catch {}
      if (speechSynthesis.speaking) speechSynthesis.cancel();
    });
  </script>
</body>
</html>

